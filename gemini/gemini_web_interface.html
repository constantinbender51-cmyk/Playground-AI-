<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Web Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col justify-center items-center p-4">

<div class="container bg-white shadow-xl rounded-2xl p-6 md:p-10 w-full">
    <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">Gemini Prompt Interface</h1>
    <p class="text-center text-gray-600 mb-8">Type your question below and press enter to get a response from Gemini.</p>

    <div class="flex flex-col space-y-4">
        <textarea id="prompt-input"
                  class="w-full h-32 md:h-40 p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-none text-gray-700 placeholder-gray-400"
                  placeholder="Ask me anything..."></textarea>
        
        <button id="send-button"
                class="w-full flex justify-center items-center py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span id="button-text">Send Prompt</span>
            <div id="loading-spinner" class="loading-spinner hidden"></div>
        </button>
    </div>

    <div id="response-container" class="mt-8">
        <div id="response-box" class="p-6 bg-gray-50 rounded-xl border border-gray-200 text-gray-800 min-h-[100px] overflow-auto">
            <p id="placeholder-text" class="text-gray-400 italic">Your response will appear here...</p>
        </div>
    </div>
</div>

<script>
    // These variables are provided by the embedding environment.
    // They are checked for existence to prevent runtime errors in a local environment.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const promptInput = document.getElementById('prompt-input');
    const sendButton = document.getElementById('send-button');
    const buttonText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const responseBox = document.getElementById('response-box');
    const placeholderText = document.getElementById('placeholder-text');

    // This is the model to use. You can change this if needed.
    const model = 'gemini-2.5-flash-preview-05-20';

    // The endpoint will be a proxy on your Railway server.
    // This prevents exposing the API key in the client-side code.
    const apiUrl = '/api/gemini-proxy';

    async function generateContent(prompt) {
        // Show loading state
        buttonText.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');
        sendButton.disabled = true;
        placeholderText.classList.add('hidden');
        responseBox.innerHTML = '';

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: "Act as a helpful, knowledgeable, and friendly assistant. Provide concise and accurate answers." }]
            },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Something went wrong with the API call.');
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                displayResponse(text, sources);
            } else {
                displayError("No response received from the model.");
            }
        } catch (error) {
            console.error('Error:', error);
            displayError(`An error occurred: ${error.message}`);
        } finally {
            // Hide loading state
            buttonText.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            sendButton.disabled = false;
        }
    }

    function displayResponse(text, sources) {
        responseBox.innerHTML = '';
        const textNode = document.createElement('p');
        textNode.innerText = text;
        responseBox.appendChild(textNode);

        if (sources.length > 0) {
            const sourcesHeader = document.createElement('h3');
            sourcesHeader.innerText = 'Sources:';
            sourcesHeader.className = 'mt-4 font-semibold text-gray-600 text-sm';
            responseBox.appendChild(sourcesHeader);

            const sourcesList = document.createElement('ul');
            sourcesList.className = 'list-disc list-inside text-gray-500 text-sm';
            sources.forEach(source => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = source.uri;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.className = 'underline hover:text-blue-500';
                link.innerText = source.title;
                listItem.appendChild(link);
                sourcesList.appendChild(listItem);
            });
            responseBox.appendChild(sourcesList);
        }
    }

    function displayError(message) {
        responseBox.innerHTML = '';
        const errorNode = document.createElement('p');
        errorNode.className = 'text-red-500 font-semibold';
        errorNode.innerText = message;
        responseBox.appendChild(errorNode);
    }

    sendButton.addEventListener('click', () => {
        const prompt = promptInput.value.trim();
        if (prompt) {
            generateContent(prompt);
        }
    });

    promptInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            const prompt = promptInput.value.trim();
            if (prompt) {
                generateContent(prompt);
            }
        }
    });

</script>

</body>
</html>
